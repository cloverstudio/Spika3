// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                    Int      @id @default(autoincrement()) @map(name: "id")
  emailAddress          String?  @unique @map(name: "email_address")
  telephoneNumber       String?  @unique @map(name: "telephone_number")
  telephoneNumberHashed String?  @unique @map(name: "telephone_number_hashed")
  displayName           String?  @map(name: "display_name")
  avatarUrl             String?  @map(name: "avatar_url")
  verificationCode      String?  @map(name: "verification_code")
  verified              Boolean  @default(false) @map(name: "verified")
  createdAt             DateTime @default(now()) @map(name: "created_at")
  modifiedAt            DateTime @default(now()) @map(name: "modified_at")
  rooms RoomUser[]

  device    Device[]
  contacts  Contact[] @relation("user")
  contactee Contact[] @relation("contact")
  messages Message[]
  messagesRecords MessageRecord[]
  @@map(name: "user")
}

model Device {
  id             Int       @id @default(autoincrement()) @map(name: "id")
  userId         Int       @map(name: "user_id")
  user           User      @relation(fields: [userId], references: [id])
  deviceId       String    @unique @map(name: "device_id")
  type           String?   @map(name: "type")
  deviceName     String?   @map(name: "device_name")
  osName         String?   @map(name: "os_name")
  osVersion      String?   @map(name: "os_version")
  appVersion     String?   @map(name: "app_version")
  token          String?   @map(name: "token")
  pushToken      String?   @map(name: "push_token")
  tokenExpiredAt DateTime? @map(name: "token_expired_at")
  createdAt      DateTime  @default(now()) @map(name: "created_at")
  modifiedAt     DateTime  @default(now()) @map(name: "modified_at")

  messages Message[]
  @@map(name: "device")
}

model File {
  id         Int    @id @default(autoincrement()) @map(name: "id")
  type       String @map(name: "type")
  relationId Int?    @map(name: "relation_id")
  path       String @map(name: "path")
  mimeType   String @map(name: "mime_type")
  fileName   String @map(name: "file_name")
  size       Int    @map(name: "size")
  clientId   String @unique @map(name: "client_id")

  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")

  @@map(name: "file")
}

model Contact {
  id         Int      @id @default(autoincrement()) @map(name: "id")
  userId     Int
  user       User     @relation("user", fields: [userId], references: [id])
  contactId  Int
  contact    User     @relation("contact", fields: [contactId], references: [id])
  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")

  @@map(name: "contact")
}

model Room {
  id Int @id @default(autoincrement()) @map(name: "id")
  type String @map(name: "type")
  name String @map(name: "name")
  avatarUrl String    @map(name: "avatar_url")
  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")
  deleted Boolean @default(false) @map(name: "deleted")

  users RoomUser[]
  messages Message[]

  @@map(name: "room")
}

model RoomUser {
  id Int @id @default(autoincrement()) @map(name: "id")
  user User @relation(fields: [userId], references: [id])
  userId Int @map(name: "user_id")
  room Room @relation(fields: [roomId], references: [id])
  roomId Int @map(name: "room_id")
  isAdmin Boolean @default(false) @map(name: "is_admin")
  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")

  @@map(name: "room_user")
}

model Message {
  id Int @id @default(autoincrement()) @map(name: "id")
  fromUserId Int @map(name: "from_user_id")
  fromUser User @relation(fields: [fromUserId], references: [id])

  fromDeviceId Int @map(name: "from_device_id")
  fromDevice Device @relation(fields: [fromDeviceId], references: [id])

  roomId Int @map(name: "room_id")
  room Room @relation(fields: [roomId], references: [id])

  type String @map(name: "type")
  seenCount Int @default(0) @map(name: "seen_count")
  deliveredCount Int @default(0) @map(name: "delivered_count")
  totalUserCount Int @map(name: "total_user_count")

  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")
  deleted Boolean @default(false) @map(name: "deleted")

  deviceMessages DeviceMessage[]
  messageRecords MessageRecord[]

  localId String? @map(name: "local_id")

  @@map(name: "message")
}

model DeviceMessage {
  id Int @id @default(autoincrement()) @map(name: "id")
  deviceId Int @map(name: "device_id")
  userId Int @map(name: "user_id")
  fromUserId Int @map(name: "from_user_id")
  fromDeviceId Int @map(name: "from_device_id")

  messageId Int @map(name: "message_id")
  message Message @relation(fields: [messageId], references: [id])

  body Json @map(name: "body")
  action String @map(name: "action")

  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")

  @@map(name: "message_device")
}

model MessageRecord {
  id Int @id @default(autoincrement()) @map(name: "id")
  messageId Int @map(name: "message_id")
  message Message @relation(fields: [messageId], references: [id])

  userId Int @map(name: "user_id")
  user User @relation(fields: [userId], references: [id])

  type String @map("string")
  reaction String? @map("reaction")

  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")

  @@unique([messageId, userId, type], name: "messageId_userId_type_unique_constraint")
  @@map(name: "message_record")
}


model Note {
  id Int @id @default(autoincrement()) @map(name: "id")
  roomId Int @map(name: "room_id")
  content String @db.Text @map("content")
  title String @default("") @map("title")

  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")

  @@map(name: "note")
}

model CallSession {
  id Int @id @default(autoincrement()) @map(name: "id")
  roomId Int @map(name: "room_id")
  content String @db.Text @map("content")
  title String @default("") @map("title")

  createdAt  DateTime @default(now()) @map(name: "created_at")
  modifiedAt DateTime @default(now()) @map(name: "modified_at")

  @@map(name: "note")
}
